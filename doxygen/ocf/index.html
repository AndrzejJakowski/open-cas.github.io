<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Open CAS Framework: Open CAS Framework</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Open CAS Framework
   </div>
   <div id="projectbrief">Open source framework of Cache Acceleration Software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Open CAS Framework </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Content:</h1>
<ul>
<li><a href="#architecture-overview">Architecture overview</a></li>
<li><a href="#library-management">Management interface</a></li>
<li><a href="#reading-and-writing-data">IO path</a></li>
</ul>
<h1>Architecture overview</h1>
<p class="">Intel(R) Cache Acceleration Software (CAS) consists of:</p><ul>
<li>Platform independent library called Open CAS Framework (OCF)</li>
<li>Platform dependent adaptation layers enabling OCF to work in different environments such as Linux kernel</li>
</ul>
<p class="">An example usage for OCF is Linux kernel (see picture below). In this case OCF operates as block level cache for block devices. For this usage model OCF comes with following adaptation layers:</p><ul>
<li><b>Library client (top adapter)</b> - its main responsibility is creating cache volume representing primary storage device. Application can read/write from/to the cache volume block device as to regular primary storage device.</li>
<li><b>Block device data object (bottom adapter)</b> - is responsible for issuing IO operations to underlying block device.</li>
</ul>
<p class="">A system administrator can manage cache instances via Intel CAS CLI management utility called "casadm".</p>
<div class="image">
<img src="deployment-1.png" alt="deployment-1.png"/>
<div class="caption">
OCF Linux deployment view</div></div>
<p> Another example of OCF usage is user space block level cache for QEMU (see picture below). In this example following adaptation layers may exist:</p><ul>
<li><b>CAS virtIO-blk driver for QEMU (top adapter)</b> - it exposes primary storage device (another virtIO driver) to guest OS via OCF library</li>
<li><b>virtIO-blk data object (bottom adapter)</b> - enables OCF to access data on primary storage device or cache device via original virtIO driver</li>
</ul>
<p class="">Please note that actual adapters depend on the environment where OCF is meant to be run. There can be different bottom adapters delivered for cache device and primary storage device. For example bottom adapter for caching device may be implemented using kernel bypass techniques, providing low-latency access to cache media.</p>
<div class="image">
<img src="deployment-2.png" alt="deployment-2.png"/>
<div class="caption">
OCF deployment in QEMU example</div></div>
 <h1>Management interface</h1>
<p class="">Management interface delivered with Intel OCF enables system administrator to:</p><ul>
<li>Configure OCF caching library to target environment, which includes installation of required platform dependent adapters.</li>
<li>Starting/stopping and managing existing cache instances.</li>
<li>Performing observability functions (e.g. retrieving performance counters)</li>
</ul>
<p class="">For more details please see below examples:</p>
<h2>Library initialization example</h2>
<p class="">OCF enables possibility use it simultaneously from two independent libraries linked into the same executable by means of concept of contexts. Each context has its own set of operations which allow to handle specific data types used by data objects within this context.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ocf_8h.html">ocf.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="comment">/* Handle to library context */</span></div><div class="line"><a class="code" href="ocf__types_8h.html#ada98ce1929967d6bae2be9b9b51dbc3d">ocf_ctx_t</a> ctx;</div><div class="line"></div><div class="line"><span class="comment">/* Your context interface */</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structocf__ctx__ops.html">ocf_ctx_ops</a> ctx_ops = {</div><div class="line"><span class="comment">/* Fill your interface functions */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">/* Your unique data object type IDs */</span></div><div class="line"><span class="keyword">enum</span> my_data_obj_type {</div><div class="line">        my_data_obj_type_1,</div><div class="line">        my_data_obj_type_2</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">/* Your data objects interface declaration */</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structocf__data__obj__ops.html">ocf_data_obj_ops</a> my_data_obj_ops1 = {</div><div class="line">        .name = <span class="stringliteral">&quot;My data object 1&quot;</span>,</div><div class="line">        <span class="comment">/* Fill your data object interface functions */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structocf__data__obj__ops.html">ocf_data_obj_ops</a> my_data_obj_ops2 = {</div><div class="line">        .name = <span class="stringliteral">&quot;My data object 2&quot;</span></div><div class="line">        <span class="comment">/* Fill your data object interface functions */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> my_cache_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> result;</div><div class="line"></div><div class="line">        result <a class="code" href="ocf__ctx_8h.html#acb39eb4a9b49c155344d2fa893ff790f">ocf_ctx_init</a>(&amp;ctx, &amp;ctx_ops)</div><div class="line">        <span class="keywordflow">if</span> (result) {</div><div class="line">                <span class="comment">/* Cannot initialze context of OCF library */</span></div><div class="line">                <span class="keywordflow">return</span> result;</div><div class="line">        }</div><div class="line">        <span class="comment">/* Initialization successful */</span></div><div class="line"></div><div class="line">        <span class="comment">/* Now we can register data objects */</span></div><div class="line">        result |= ocf_ctx_register_data_obj_ops(ctx, &amp;my_data_obj_ops1,</div><div class="line">                        my_data_obj_type_1);</div><div class="line">        <span class="keywordflow">if</span> (result) {</div><div class="line">                <span class="comment">/* Cannot register data object interface */</span></div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        result |= ocf_ctx_register_data_obj_ops(ctx, &amp;my_data_obj_ops2,</div><div class="line">                        my_data_obj_type_2);</div><div class="line">        <span class="keywordflow">if</span> (result) {</div><div class="line">                <span class="comment">/* Cannot register data object interface */</span></div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line"></div><div class="line">err:</div><div class="line">        <span class="comment">/* In case of failure we destroy context and propagate error code */</span></div><div class="line">        <a class="code" href="ocf__ctx_8h.html#a9448bdc0aa5a4669b5d173670dccd7c5">ocf_ctx_exit</a>(ctx);</div><div class="line">        <span class="keywordflow">return</span> result;</div><div class="line">}</div></div><!-- fragment --><h2>Cache management</h2>
<p class="">OCF library API provides management functions (<a class="el" href="ocf__mngt_8h.html">ocf_mngt.h</a>). This interface enables user to manage cache instances. Examples:</p><ul>
<li>Start cache <div class="fragment"><div class="line"><span class="keywordtype">int</span> result;</div><div class="line"><a class="code" href="ocf__types_8h.html#ae86cad0c8b31e7a05ffdc9edf0f77c81">ocf_cache_t</a> cache; <span class="comment">/* Handle to your cache */</span></div><div class="line"><span class="keyword">struct </span><a class="code" href="structocf__mngt__cache__config.html">ocf_mngt_cache_config</a> cfg; <span class="comment">/* Your cache configuration */</span></div><div class="line"></div><div class="line"><span class="comment">/* Prepare your cache configuration */</span></div><div class="line"></div><div class="line"><span class="comment">/* Configure cache mode */</span></div><div class="line">cfg.<a class="code" href="structocf__mngt__cache__config.html#a343323016ae5637a440d9ada7659de78">cache_mode</a> = <a class="code" href="ocf__def_8h.html#a292caafc3e62c0b4d6dfb07e4f58711fa5200a5db7c7c0b7f9b13a66c244092e3">ocf_cache_mode_wt</a>;</div><div class="line"></div><div class="line"><span class="comment">/* Now tell how your cache will be initialzed. Selech warm or cold cache */</span></div><div class="line">cfg.init_mode = ocf_init_mode_init;</div><div class="line"></div><div class="line">cfg.uuid.data = <span class="stringliteral">&quot;/path/to/your/cache/or/unique/id&quot;</span>;</div><div class="line"></div><div class="line"><span class="comment">/* Specify cache data object type */</span></div><div class="line">cfg.data_obj_type = my_data_obj_type_1;</div><div class="line"></div><div class="line"><span class="comment">/* Other cache configuration */</span></div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">/* Start cache. */</span></div><div class="line">result = <a class="code" href="ocf__mngt_8h.html#aa9088c6cec2218b6c1c14097d2851546">ocf_mngt_cache_start</a>(cas, &amp;cache, cfg);</div><div class="line"><span class="keywordflow">if</span> (!result) {</div><div class="line">        <span class="comment">/* Your cache was created successfully */</span></div><div class="line">}</div></div><!-- fragment --></li>
<li>Add core (primary storage device) to cache <div class="fragment"><div class="line"><span class="keywordtype">int</span> result;</div><div class="line"><a class="code" href="ocf__types_8h.html#ac545b9afe815a3a80362675e3b4197c6">ocf_core_t</a> core;  <span class="comment">/* Handle to your core */</span></div><div class="line"><span class="keyword">struct </span><a class="code" href="structocf__mngt__core__config.html">ocf_mngt_core_config</a> cfg; <span class="comment">/* Your core configuration */</span></div><div class="line"></div><div class="line"><span class="comment">/* Prepare core configuration */</span></div><div class="line"></div><div class="line"><span class="comment">/* Select core data object type */</span></div><div class="line">cfg.<a class="code" href="structocf__mngt__core__config.html#af9957579bb878929d32c8ef809ebdbbc">data_obj_type</a> = my_data_obj_type_2;</div><div class="line"><span class="comment">/* Set UUID or path of your core */</span></div><div class="line">cfg.uuid.data = <span class="stringliteral">&quot;/path/to/your/core/or/unique/id&quot;</span>;</div><div class="line"></div><div class="line">result = <a class="code" href="ocf__mngt_8h.html#a6bc49f97a475ecd5695c6bbc30280da9">ocf_mngt_cache_add_core</a>(cache, &amp;core, &amp;cfg);</div><div class="line"><span class="keywordflow">if</span> (!result) {</div><div class="line">        <span class="comment">/* Your core was added successfully */</span></div><div class="line">}</div></div><!-- fragment --></li>
</ul>
<h2>Management interface considerations</h2>
<p class="">Each device (cache or core) is assigned with ID, either automatically by OCF or explicitly specified by user. It is possible to retrieve handle to cache instance via <a class="el" href="ocf__cache_8h.html#ab7bb80a80804e34c8caa6677baa117ec">ocf_cache_get_id</a>. To get handle to core instance please use <a class="el" href="ocf__core_8h.html#a2c531aa89bd238731a4d76a128a165ca">ocf_core_get_id</a>.</p>
<p class="">Cache management operations are thread safe - it is possible to perform cache management from many threads at a time. There is a possiblity to "batch" several cache management operations and execute them under cache management lock. To do this user needs to first obtain cache management lock, perform management operations and finally release the lock. For reference see example below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> my_complex_work(<a class="code" href="ocf__types_8h.html#a9041bbceb5baf9b3415ca382ba3c981a">ocf_cache_id_t</a> <a class="code" href="structocf__mngt__core__config.html#a4f719873c061e79382206f1bfb1d9a2a">cache_id</a>,</div><div class="line">                <a class="code" href="ocf__types_8h.html#aef2b6c4e6d34a59ddaedf07ec337619a">ocf_core_id_t</a> <a class="code" href="structocf__mngt__core__config.html#a4153cc889cc2d92eed2b1abef251ec99">core_id</a>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> result;</div><div class="line">        <a class="code" href="ocf__types_8h.html#ae86cad0c8b31e7a05ffdc9edf0f77c81">ocf_cache_t</a> cache; <span class="comment">/* Handle to your cache */</span></div><div class="line">        <a class="code" href="ocf__types_8h.html#ac545b9afe815a3a80362675e3b4197c6">ocf_core_t</a> core; <span class="comment">/* Handle to your core */</span></div><div class="line"></div><div class="line">        <span class="comment">/* Get cache handle */</span></div><div class="line">        result = <a class="code" href="ocf__mngt_8h.html#a14ca6c8c50720c923db161217f05ffd9">ocf_mngt_cache_get</a>(cas, <a class="code" href="structocf__mngt__core__config.html#a4f719873c061e79382206f1bfb1d9a2a">cache_id</a>, &amp;cache);</div><div class="line">        <span class="keywordflow">if</span> (result)</div><div class="line">                <span class="keywordflow">return</span> result;</div><div class="line"></div><div class="line">        <span class="comment">/* Lock cache */</span></div><div class="line">        result = <a class="code" href="ocf__mngt_8h.html#a5da1b1b927ed790f45bb9c6738eea3d2">ocf_mngt_cache_lock</a>(cache);</div><div class="line">        <span class="keywordflow">if</span> (result) {</div><div class="line">                <a class="code" href="ocf__mngt_8h.html#a01c5d7ab3cdd277a823f831c3c3b415c">ocf_mngt_cache_put</a>(cache);</div><div class="line">                <span class="keywordflow">return</span> result;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Get core handle */</span></div><div class="line">        result = <a class="code" href="ocf__core_8h.html#a33c7a1deee50cbf63c503422ef4f1d13">ocf_core_get</a>(cache, <a class="code" href="structocf__mngt__core__config.html#a4153cc889cc2d92eed2b1abef251ec99">core_id</a>, &amp;core);</div><div class="line">        <span class="keywordflow">if</span> (result) {</div><div class="line">                result = -1;</div><div class="line">                <span class="keywordflow">goto</span> END;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Cache is locked, you can perform your activities */</span></div><div class="line"></div><div class="line">        <span class="comment">/* 1. Flush your core */</span></div><div class="line">        result = <a class="code" href="ocf__mngt_8h.html#a1a45f0c6056d2df19e09beddadccab8c">ocf_mngt_core_flush</a>(cache, <a class="code" href="structocf__mngt__core__config.html#a4153cc889cc2d92eed2b1abef251ec99">core_id</a>, <span class="keyword">true</span>);</div><div class="line">        <span class="keywordflow">if</span> (result) {</div><div class="line">                <span class="keywordflow">goto</span> END;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* 2. Your others operations including internal actions */</span></div><div class="line"></div><div class="line">        <span class="comment">/* 3. Removing core form cache */</span></div><div class="line">        result = <a class="code" href="ocf__mngt_8h.html#ae3584e24516778458ddb9ffa7e59609e">ocf_mngt_cache_remove_core</a>(cache, <a class="code" href="structocf__mngt__core__config.html#a4153cc889cc2d92eed2b1abef251ec99">core_id</a>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">END:</div><div class="line">        <a class="code" href="ocf__mngt_8h.html#a3b6436844ada95deeeb5266d01d8cc7b">ocf_mngt_cache_unlock</a>(cache); <span class="comment">/* Remember to unlock cache */</span></div><div class="line">        <a class="code" href="ocf__mngt_8h.html#a01c5d7ab3cdd277a823f831c3c3b415c">ocf_mngt_cache_put</a>(cache); <span class="comment">/* Release cache referance */</span></div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> result;</div><div class="line">}</div></div><!-- fragment --><h1>IO path</h1>
<p class="">Please refer to below sequence diagram for detailed IO flow. Typical IO path includes:</p><ul>
<li><b>IO allocation</b> - creating new IO instance that will be submitted to OCF for processing</li>
<li><b>IO configuration</b> - specifying address and length, IO class, flags and completion function</li>
<li><b>IO submission</b> - actual IO submission to OCF. OCF will perform cache lookup and based on its results will return data from cache or primary storage device</li>
<li><b>IO completion</b> - is signalled by calling completion function specified in IO configuration phase</li>
</ul>
<div class="image">
<img src="io-path.png" alt="io-path.png"/>
<div class="caption">
An example of IO flow</div></div>
<p> ## IO submission example </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ocf_8h.html">ocf.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> read_end(<span class="keyword">struct</span> <a class="code" href="structocf__io.html">ocf_io</a> *io, <span class="keywordtype">int</span> error)</div><div class="line">{</div><div class="line">        <span class="comment">/* Your IO has been finished. Check the result and inform upper</span></div><div class="line"><span class="comment">         * layers.</span></div><div class="line"><span class="comment">         */</span></div><div class="line"></div><div class="line">        <span class="comment">/* Release IO */</span></div><div class="line">        ocf_io_put(io);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> read(<a class="code" href="ocf__types_8h.html#ac545b9afe815a3a80362675e3b4197c6">ocf_core_t</a> core, <span class="keywordtype">void</span> *data, addr, uint32_t length)</div><div class="line">{</div><div class="line">        <span class="comment">/* Allocate IO */</span></div><div class="line">        <span class="keyword">struct </span><a class="code" href="structocf__io.html">ocf_io</a> *io = <a class="code" href="ocf__core_8h.html#a197b9ac828d623f7e650275c3ef26541">ocf_new_io</a>(core);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!io) {</div><div class="line">                <span class="comment">/* Cannot allocate IO */</span></div><div class="line">                <span class="keywordflow">return</span> -ENOMEM;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Configure IO, set address, flags, IO class, and etc... */</span></div><div class="line">        ocf_io_configure(io, <a class="code" href="structocf__io.html#a0e89cf6b9f6cd3125470b1bed2b823df">addr</a>, length, OCF_READ, 0, 0);</div><div class="line"></div><div class="line">        <span class="comment">/* Set completion context and function */</span></div><div class="line">        ocf_io_set_cmpl(io, NULL, NULL, read_end);</div><div class="line"></div><div class="line">        <span class="comment">/* Set data */</span></div><div class="line">        <span class="keywordflow">if</span> (ocf_io_set_data(io, data, 0)) {</div><div class="line">                ocf_io_put(io);</div><div class="line">                <span class="keywordflow">return</span> -EINVAL;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Send IO requests to the cache */</span></div><div class="line">        ocf_submit_io(io);</div><div class="line"></div><div class="line">        <span class="comment">/* Just it */</span></div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
